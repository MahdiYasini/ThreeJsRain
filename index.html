<!-- Created By Mahdi Yasini - 951113091 -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="./css/style.css">
    <title>Three js</title>
  </head>

  <body>
    <!-- Three js local library -->
    <!-- Also we can use CDN -->
    <script src="./js/three.js"></script>

    <!-- Let's start -->
    <script>
      let scene,
        camera,
        renderer,
        cloudParticles = [],
        flash,
        rain,
        rainGeo,
        //heavy of rain also we could change
        rainCount = 30000;

      function init() {
        //Create Scene
        scene = new THREE.Scene();

        //Create Camera
        camera = new THREE.PerspectiveCamera(
          //This Degree is the distance between camera and cloud.
          60,
          window.innerWidth / window.innerHeight,
          //On or off (Transparency)
          1,
          //Contrast
          1000
        );
        camera.position.z = 0;
        //IF we set x = 0, we see rain in side or set 5 we see the top
        camera.rotation.x = 1.16;
        camera.rotation.y = -0.12;
        camera.rotation.z = 0.27;

        //Set up light
        //Set up ambient light.
        ambient = new THREE.AmbientLight(0x000080);
        //Add light to scene
        scene.add(ambient);

        //set up directional light in this case for moonlight
        directionalLight = new THREE.DirectionalLight(0xB0C4DE);
        // Set the location of light
        directionalLight.position.set(0, 0, 1);
        //Add the directional light to scene
        scene.add(directionalLight);

        //set up flashlight
        flash = new THREE.PointLight(0x062d89, 30, 500, 1.7);
        //Set location of flash light
        flash.position.set(500, 500, 500);
        //Add flash to scene
        scene.add(flash);

        //Set Renderer (like WebGl)
        renderer = new THREE.WebGLRenderer();

        //Set up Fog
        //Opacity of fog is 0.002
        scene.fog = new THREE.FogExp2(0x11111f, 0.002);
        renderer.setClearColor(scene.fog.color);

        //Set up size screen (Responsive for each size screen)
        renderer.setSize(window.innerWidth, window.innerHeight);

        //Set canvas (for body in html)
        document.body.appendChild(renderer.domElement);

        //Set up rain
        rainGeo = new THREE.Geometry();
        //Vector3 is library of vector for locate each drop
        //We set 30000 points in random location
        for (let i = 0; i < rainCount; i++) {
          rainDrop = new THREE.Vector3(
            Math.random() * 400 - 200,
            Math.random() * 500 - 250,
            Math.random() * 400 - 200
          );
          rainDrop.velocity = {};
          rainDrop.velocity = 0;
          //Push drops location to rainGeo 
          rainGeo.vertices.push(rainDrop);
        }
        
        rainMaterial = new THREE.PointsMaterial({
          //Drops color
          color: 0xaaaaaa,
          //Drop size.
          size: 0.3,

          transparent: true  
        });
        rain = new THREE.Points(rainGeo, rainMaterial);
        scene.add(rain);

        //Create cloud
        let loader = new THREE.TextureLoader();
        //Define image for cloud
        loader.load("smoke.png", function(texture) {
          cloudGeo = new THREE.PlaneBufferGeometry(500, 500);
          cloudMaterial = new THREE.MeshLambertMaterial({
            map: texture,
            transparent: true
          });
          //Layer of clouds
          // p is one of factor for rain speed
          for (let p = 0; p < 200; p++) {
            let cloud = new THREE.Mesh(cloudGeo, cloudMaterial);
            //locate each cloud (The y-axis is constant)
            cloud.position.set(
              Math.random() * 800 - 400,
              500,
              Math.random() * 500 - 450
            );
            cloud.rotation.x = 1.16;
            cloud.rotation.y = -0.12;
            cloud.rotation.z = Math.random() * 360;
            cloud.material.opacity = 0.6;
            cloudParticles.push(cloud);
            scene.add(cloud);
          }
          animate();
        });
      }
      function animate() {
        // Cloud movement
        cloudParticles.forEach(p => {
          p.rotation.z -= 0.003;
        });

        //Animate rain
        rainGeo.vertices.forEach(p => {
          p.velocity -= 0.1 + Math.random() * 0.1;
          p.y += p.velocity;
          if (p.y < -200) {
            p.y = 200;
            p.velocity = -5;
          }
        });
        //It update that result the rain (points) fall down (descend)
        rainGeo.verticesNeedUpdate = true;
        rain.rotation.y += 0.002;

        //Animate Flash
        //Set flash frequent
        if (Math.random() > 0.95 || flash.power > 100) {
          if (flash.power < 100)
            flash.position.set(
              Math.random() * 400,
              300 + Math.random() * 200,
              100
            );
          flash.power = 50 + Math.random() * 500;
        }

        
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      init();
    </script>
    <!-- Set rain and thunder audio -->
    <audio  autoplay loop>
            <source src="./audio/rain.mp3" type="audio/mpeg">
    </audio>
    <audio  autoplay loop>
      <source src="./audio/rain2.mp3" type="audio/mpeg">
    </audio>
  </body>
</html>
